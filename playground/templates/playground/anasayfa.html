{% extends "playground/base.html" %}
{% load static %}

{% block title %}Ana Sayfa - Pera Kids{% endblock %}

{% block content %}
<div class="container">
    <h1 class="page-title">Mağazamızdaki Ürünler</h1>

    {% if urunler_listesi %}
        <ul class="urun-listesi">
            {% for product in urunler_listesi %}
                <li class="urun-karti">
                    <div class="urun-galeri" id="product-gallery-{{ product.id }}">
                        {% with main_color=product.get_main_color %}
                            {% if main_color %}
                                {% for img in main_color.images.all %}
                                    <img class="galeri-img {% if forloop.first %}active{% endif %}" src="{{ img.image.url }}" alt="{{ product.name }} {{ main_color.color_name }}" style="width:100%;height:220px;object-fit:cover;position:absolute;top:0;left:0;">
                                {% endfor %}
                                <div class="galeri-controls" id="gallery-controls-{{ product.id }}">
                                    {% for img in main_color.images.all %}
                                        <span class="galeri-dot {% if forloop.first %}active{% endif %}" data-index="{{ forloop.counter0 }}"></span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <img class="galeri-img active" src="{% static 'playground/img/placeholder.png' %}" alt="{{ product.name }}" style="width:100%;height:220px;object-fit:cover;position:absolute;top:0;left:0;">
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="urun-karti-icerik">
                        <h2><a href="{% url 'playground:urun_detay' product.slug %}">{{ product.name }}</a></h2>
                        <ul class="renk-secenekleri">
                            {% for color in product.colors.all %}
                                {% with color_images=color.images.all %}
                                    {% if color_images %}
                                        <li class="renk-kutusu {% if color.is_main_color %}active{% endif %}"
                                            style="background-color: {{ color.color_name|default_if_none:'#cccccc' }};"
                                            title="{{ color.color_name }}"
                                            data-images='[{% for img in color_images %}{{ '"' }}{{ img.image.url }}{{ '"' }}{% if not forloop.last %},{% endif %}{% endfor %}]'
                                            data-product-id="{{ product.id }}"
                                            data-price="{{ color.price }}">
                                        </li>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </ul>
                        <div class="urun-fiyati">
                            {% with main_color=product.get_main_color %}
                                {% if main_color %}
                                    {{ main_color.price }} TL
                                {% endif %}
                            {% endwith %}
                        </div>
                        <a href="{% url 'playground:urun_detay' product.slug %}" class="detay-link">Detayları Gör</a>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p style="text-align:center;">Gösterilecek ürün bulunamadı.</p>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Renk seçimi ve galeri güncelleme
        const colorSwatches = document.querySelectorAll('.renk-kutusu');
        colorSwatches.forEach(swatch => {
            swatch.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                const productId = this.dataset.productId;
                const imagesData = this.dataset.images;
                let imageUrls = [];
                try {
                    imageUrls = JSON.parse(imagesData.replace(/'/g, '"'));
                } catch (e) {}
                const gallery = document.getElementById(`product-gallery-${productId}`);
                const controlsId = `gallery-controls-${productId}`;
                let controls;
                if (gallery && imageUrls.length > 0) {
                    gallery.innerHTML = '';
                    imageUrls.forEach((url, idx) => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'galeri-img' + (idx === 0 ? ' active' : '');
                        img.alt = '';
                        gallery.appendChild(img);
                    });
                    // Slider dotları
                    controls = document.createElement('div');
                    controls.className = 'galeri-controls';
                    controls.id = controlsId;
                    imageUrls.forEach((url, idx) => {
                        const dot = document.createElement('span');
                        dot.className = 'galeri-dot' + (idx === 0 ? ' active' : '');
                        dot.setAttribute('data-index', idx);
                        dot.addEventListener('click', function(e) {
                            e.stopPropagation();
                            e.preventDefault();
                            const imgs = gallery.querySelectorAll('.galeri-img');
                            imgs.forEach(img => img.classList.remove('active'));
                            imgs[idx].classList.add('active');
                            controls.querySelectorAll('.galeri-dot').forEach(d => d.classList.remove('active'));
                            dot.classList.add('active');
                        });
                        controls.appendChild(dot);
                    });
                    gallery.appendChild(controls);
                }
                const parentCard = this.closest('.urun-karti');
                parentCard.querySelectorAll('.renk-kutusu').forEach(s => s.classList.remove('active'));
                this.classList.add('active');
                // Fiyatı güncelle
                const priceDiv = parentCard.querySelector('.urun-fiyati');
                if (priceDiv) {
                    const priceValue = this.getAttribute('data-price');
                    if (priceValue) {
                        priceDiv.textContent = priceValue + ' TL';
                    }
                }
            });
        });
        // Galeri sliderı (ilk yüklemede)
        document.querySelectorAll('.galeri-controls').forEach(controls => {
            const gallery = controls.closest('.urun-galeri');
            const imgs = gallery.querySelectorAll('.galeri-img');
            controls.querySelectorAll('.galeri-dot').forEach((dot, idx) => {
                dot.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    imgs.forEach(img => img.classList.remove('active'));
                    imgs[idx].classList.add('active');
                    controls.querySelectorAll('.galeri-dot').forEach(d => d.classList.remove('active'));
                    dot.classList.add('active');
                });
            });
        });
    });
</script>
{% endblock %}